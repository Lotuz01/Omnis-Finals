# Regras de Alerta para Sistema de Gestão
groups:
  - name: sistema-gestao-alerts
    rules:
      # Alertas de aplicação
      - alert: AplicacaoIndisponivel
        expr: up{job="sistema-gestao-app"} == 0
        for: 1m
        labels:
          severity: critical
          service: aplicacao
        annotations:
          summary: "Aplicação Sistema de Gestão está indisponível"
          description: "A aplicação não está respondendo há mais de 1 minuto."

      - alert: HealthCheckFalhando
        expr: probe_success{job="sistema-gestao-health"} == 0
        for: 2m
        labels:
          severity: critical
          service: aplicacao
        annotations:
          summary: "Health check da aplicação falhando"
          description: "O health check está falhando há mais de 2 minutos."

      - alert: TempoRespostaAlto
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="sistema-gestao-app"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: aplicacao
        annotations:
          summary: "Tempo de resposta alto na aplicação"
          description: "95% das requisições estão levando mais de 2 segundos para responder."

      - alert: TaxaErroAlta
        expr: rate(http_requests_total{job="sistema-gestao-app",status=~"5.."}[5m]) / rate(http_requests_total{job="sistema-gestao-app"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: aplicacao
        annotations:
          summary: "Taxa de erro alta na aplicação"
          description: "Mais de 5% das requisições estão retornando erro 5xx."

      # Alertas de banco de dados
      - alert: BancoDadosIndisponivel
        expr: up{job="postgresql"} == 0
        for: 1m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Banco de dados PostgreSQL indisponível"
          description: "O banco de dados não está respondendo há mais de 1 minuto."

      - alert: ConexoesBancoAltas
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Muitas conexões ativas no banco de dados"
          description: "Mais de 80% das conexões do banco estão sendo utilizadas."

      - alert: CacheHitRatioBaixo
        expr: pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read) < 0.9
        for: 10m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Taxa de acerto do cache do banco baixa"
          description: "A taxa de acerto do cache está abaixo de 90%."

      - alert: TamanhoBancoCrescendoRapido
        expr: increase(pg_database_size_bytes[1h]) > 1073741824  # 1GB
        for: 0m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Banco de dados crescendo rapidamente"
          description: "O banco cresceu mais de 1GB na última hora."

      # Alertas de sistema
      - alert: UsoMemoriaAlto
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Uso de memória alto"
          description: "Uso de memória está acima de 90%."

      - alert: UsoCPUAlto
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Uso de CPU alto"
          description: "Uso de CPU está acima de 80% por mais de 10 minutos."

      - alert: EspacoDiscoPouco
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Pouco espaço em disco"
          description: "Menos de 10% de espaço livre no disco."

      - alert: LoadAverageAlto
        expr: node_load15 > 2
        for: 10m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Load average alto"
          description: "Load average de 15 minutos está acima de 2."

      # Alertas de Redis
      - alert: RedisIndisponivel
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: cache
        annotations:
          summary: "Redis indisponível"
          description: "O Redis não está respondendo há mais de 1 minuto."

      - alert: RedisMemoriaAlta
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Uso de memória do Redis alto"
          description: "Redis está usando mais de 90% da memória configurada."

      # Alertas de Nginx
      - alert: NginxIndisponivel
        expr: up{job="nginx"} == 0
        for: 1m
        labels:
          severity: critical
          service: proxy
        annotations:
          summary: "Nginx indisponível"
          description: "O Nginx não está respondendo há mais de 1 minuto."

      - alert: NginxTaxaErroAlta
        expr: rate(nginx_http_requests_total{status=~"5.."}[5m]) / rate(nginx_http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: proxy
        annotations:
          summary: "Taxa de erro alta no Nginx"
          description: "Mais de 5% das requisições no Nginx estão retornando erro 5xx."

      # Alertas de containers
      - alert: ContainerReiniciadoFrequentemente
        expr: increase(container_start_time_seconds[1h]) > 3
        for: 0m
        labels:
          severity: warning
          service: container
        annotations:
          summary: "Container reiniciado frequentemente"
          description: "Container {{ $labels.name }} foi reiniciado mais de 3 vezes na última hora."

      - alert: ContainerUsoCPUAlto
        expr: rate(container_cpu_usage_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          service: container
        annotations:
          summary: "Container com uso de CPU alto"
          description: "Container {{ $labels.name }} está usando mais de 80% de CPU."

      - alert: ContainerUsoMemoriaAlto
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: container
        annotations:
          summary: "Container com uso de memória alto"
          description: "Container {{ $labels.name }} está usando mais de 90% da memória limite."

      # Alertas de backup
      - alert: BackupFalhando
        expr: time() - backup_last_success_timestamp > 86400  # 24 horas
        for: 0m
        labels:
          severity: critical
          service: backup
        annotations:
          summary: "Backup não executado nas últimas 24 horas"
          description: "O último backup bem-sucedido foi há mais de 24 horas."

      # Alertas de segurança
      - alert: TentativasLoginFalhaSuspeitas
        expr: increase(failed_login_attempts_total[5m]) > 10
        for: 0m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Muitas tentativas de login falharam"
          description: "Mais de 10 tentativas de login falharam nos últimos 5 minutos."

      - alert: RateLimitAtivado
        expr: increase(rate_limit_exceeded_total[5m]) > 50
        for: 0m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Rate limit sendo ativado frequentemente"
          description: "Rate limit foi ativado mais de 50 vezes nos últimos 5 minutos."

  # Grupo de alertas críticos
  - name: sistema-gestao-critical
    rules:
      - alert: SistemaCompletamenteIndisponivel
        expr: up{job="sistema-gestao-app"} == 0 and up{job="postgresql"} == 0
        for: 30s
        labels:
          severity: critical
          service: system
        annotations:
          summary: "CRÍTICO: Sistema completamente indisponível"
          description: "Tanto a aplicação quanto o banco de dados estão indisponíveis."

      - alert: PerformanceCritica
        expr: |
          (
            histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="sistema-gestao-app"}[5m])) > 5
          ) and (
            rate(http_requests_total{job="sistema-gestao-app",status=~"5.."}[5m]) / rate(http_requests_total{job="sistema-gestao-app"}[5m]) > 0.1
          )
        for: 2m
        labels:
          severity: critical
          service: performance
        annotations:
          summary: "CRÍTICO: Performance extremamente degradada"
          description: "Sistema com tempo de resposta > 5s e taxa de erro > 10%."

      - alert: RecursosEsgotados
        expr: |
          (
            (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.95
          ) and (
            (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.05
          )
        for: 1m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "CRÍTICO: Recursos do sistema esgotados"
          description: "Memória > 95% e disco < 5% de espaço livre."